<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIMS|ICS_PA2 å®éªŒæŠ¥å‘Š</title>
  
  
  <meta name="description" content="ğŸ™">
  <meta name="author" content="OCTOPUS">
  
  
  
  <meta property="og:url" content="http://localhost:1313/2025/11/11/ics_pa2-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">
  <meta property="og:site_name" content="DIMS">
  <meta property="og:title" content="ICS_PA2 å®éªŒæŠ¥å‘Š">
  <meta property="og:description" content="å®éªŒè¿›åº¦ æˆ‘å·²å®Œæˆ PA2 çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶é€šè¿‡äº†æ‰€æœ‰çš„æµ‹è¯•æ ·ä¾‹ã€‚
å¿…ç­”é¢˜ ä¸åœè®¡ç®—çš„æœºå™¨ #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #define NREG 4 #define NMEM 16 // å®šä¹‰æŒ‡ä»¤æ ¼å¼ typedef union { struct { uint8_t rs : 2, rt : 2, op : 4; } rtype; struct { uint8_t addr : 4 , op : 4; } mtype; uint8_t inst; } inst_t; #define DECODE_R(inst) uint8_t rt = (inst).rtype.rt, rs = (inst).rtype.rs #define DECODE_M(inst) uint8_t addr = (inst).mtype.addr uint8_t pc = 0; // PC, Cè¯­è¨€ä¸­æ²¡æœ‰4ä½çš„æ•°æ®ç±»å‹, æˆ‘ä»¬é‡‡ç”¨8ä½ç±»å‹æ¥è¡¨ç¤º uint8_t R[NREG] = {}; // å¯„å­˜å™¨ uint8_t M[NMEM] = { // å†…å­˜, å…¶ä¸­åŒ…å«ä¸€ä¸ªè®¡ç®—z = x &#43; yçš„ç¨‹åº 0b11100110, // load 6# | R[0] &lt;- M[y] 0b00000100, // mov r1, r0 | R[1] &lt;- R[0] 0b11100101, // load 5# | R[0] &lt;- M[x] 0b00010001, // add r0, r1 | R[0] &lt;- R[0] &#43; R[1] 0b11110111, // store 7# | M[z] &lt;- R[0] 0b00010000, // x = 16 0b00100001, // y = 33 0b00000000, // z = 0 }; int halt = 0; // ç»“æŸæ ‡å¿— // æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ void exec_once() { inst_t this; this.inst = M[pc]; // å–æŒ‡ switch (this.rtype.op) { // æ“ä½œç è¯‘ç  æ“ä½œæ•°è¯‘ç  æ‰§è¡Œ case 0b0000: { DECODE_R(this); R[rt] = R[rs]; break; } case 0b0001: { DECODE_R(this); R[rt] &#43;= R[rs]; break; } case 0b1110: { DECODE_M(this); R[0] = M[addr]; break; } case 0b1111: { DECODE_M(this); M[addr] = R[0]; break; } default: printf(&#34;Invalid instruction with opcode = %x, halting...\n&#34;, this.rtype.op); halt = 1; break; } pc &#43;&#43;; // æ›´æ–°PC } int main() { while (1) { exec_once(); if (halt) break; } printf(&#34;The result of 16 &#43; 33 is %d\n&#34;, M[7]); return 0; } é—®é¢˜ï¼š ç”»å‡ºåœ¨YEMUä¸Šæ‰§è¡Œçš„åŠ æ³•ç¨‹åºçš„çŠ¶æ€æœº">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-11T14:58:52+00:00">
    <meta property="article:modified_time" content="2025-11-11T14:58:52+00:00">
    <meta property="article:tag" content="ICS">
    <meta property="article:tag" content="PA">

  
  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ICS_PA2 å®éªŒæŠ¥å‘Š">
  <meta name="twitter:description" content="å®éªŒè¿›åº¦ æˆ‘å·²å®Œæˆ PA2 çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶é€šè¿‡äº†æ‰€æœ‰çš„æµ‹è¯•æ ·ä¾‹ã€‚
å¿…ç­”é¢˜ ä¸åœè®¡ç®—çš„æœºå™¨ #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #define NREG 4 #define NMEM 16 // å®šä¹‰æŒ‡ä»¤æ ¼å¼ typedef union { struct { uint8_t rs : 2, rt : 2, op : 4; } rtype; struct { uint8_t addr : 4 , op : 4; } mtype; uint8_t inst; } inst_t; #define DECODE_R(inst) uint8_t rt = (inst).rtype.rt, rs = (inst).rtype.rs #define DECODE_M(inst) uint8_t addr = (inst).mtype.addr uint8_t pc = 0; // PC, Cè¯­è¨€ä¸­æ²¡æœ‰4ä½çš„æ•°æ®ç±»å‹, æˆ‘ä»¬é‡‡ç”¨8ä½ç±»å‹æ¥è¡¨ç¤º uint8_t R[NREG] = {}; // å¯„å­˜å™¨ uint8_t M[NMEM] = { // å†…å­˜, å…¶ä¸­åŒ…å«ä¸€ä¸ªè®¡ç®—z = x &#43; yçš„ç¨‹åº 0b11100110, // load 6# | R[0] &lt;- M[y] 0b00000100, // mov r1, r0 | R[1] &lt;- R[0] 0b11100101, // load 5# | R[0] &lt;- M[x] 0b00010001, // add r0, r1 | R[0] &lt;- R[0] &#43; R[1] 0b11110111, // store 7# | M[z] &lt;- R[0] 0b00010000, // x = 16 0b00100001, // y = 33 0b00000000, // z = 0 }; int halt = 0; // ç»“æŸæ ‡å¿— // æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ void exec_once() { inst_t this; this.inst = M[pc]; // å–æŒ‡ switch (this.rtype.op) { // æ“ä½œç è¯‘ç  æ“ä½œæ•°è¯‘ç  æ‰§è¡Œ case 0b0000: { DECODE_R(this); R[rt] = R[rs]; break; } case 0b0001: { DECODE_R(this); R[rt] &#43;= R[rs]; break; } case 0b1110: { DECODE_M(this); R[0] = M[addr]; break; } case 0b1111: { DECODE_M(this); M[addr] = R[0]; break; } default: printf(&#34;Invalid instruction with opcode = %x, halting...\n&#34;, this.rtype.op); halt = 1; break; } pc &#43;&#43;; // æ›´æ–°PC } int main() { while (1) { exec_once(); if (halt) break; } printf(&#34;The result of 16 &#43; 33 is %d\n&#34;, M[7]); return 0; } é—®é¢˜ï¼š ç”»å‡ºåœ¨YEMUä¸Šæ‰§è¡Œçš„åŠ æ³•ç¨‹åºçš„çŠ¶æ€æœº">

  
  
  <script>
    (function() {
      
      document.documentElement.classList.add('dark');
      localStorage.theme = 'dark';
    })();
  </script>
  
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
  
  
  <link rel="icon" type="image/webp" href="/images/favicon.webp">
  
  
  
  <link rel="stylesheet" href="/css/index.min.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  
</head>
<body class=" is-post">
  
<div class="floating-shapes">
  <span class="shape" style="--delay:0s;--x:15%;--y:25%">âœ¦</span>
  <span class="shape" style="--delay:1.2s;--x:85%;--y:15%">â—‹</span>
  <span class="shape" style="--delay:2.5s;--x:75%;--y:65%">âœ¦</span>
  <span class="shape" style="--delay:0.8s;--x:10%;--y:55%">â—‹</span>
  <span class="shape" style="--delay:1.8s;--x:90%;--y:45%">âœ¦</span>
  <span class="shape" style="--delay:3s;--x:25%;--y:80%">â—‹</span>
</div>

  <header class="header" data-glass-nav data-liquid-glass="header">
  <div class="header-inner">
    <a href="/" class="logo">
      <span class="logo-text">DIMS</span>
    </a>
    
    <nav class="nav">
      
        <a href="/" class="nav-link">
          ä¸»é¡µ
        </a>
      
        <a href="/archives" class="nav-link">
          å½’æ¡£
        </a>
      
        <a href="/gallery" class="nav-link">
          ç›¸å†Œ
        </a>
      
        <a href="/moments" class="nav-link">
          æ—¥å¿—
        </a>
      
        <a href="/about" class="nav-link">
          å…³äº
        </a>
      
    </nav>
    
    <div class="header-actions">
      
      <button class="icon-btn search-toggle" aria-label="Search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </button>
    </div>
  </div>
</header>


<div class="search-modal" id="searchModal">
  <div class="search-container">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ–‡ç« ..." autocomplete="off">
      <button class="icon-btn search-close" id="searchClose" aria-label="Close search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="search-footer">
      <span class="search-hint">æŒ‰ <kbd>ESC</kbd> å…³é—­</span>
      <span class="search-hint"><kbd>â†‘</kbd> <kbd>â†“</kbd> é€‰æ‹©</span>
      <span class="search-hint"><kbd>Enter</kbd> æ‰“å¼€</span>
    </div>
  </div>
</div>

  
  <main class="main">
    <div class="layout layout-full">
      <section class="content content-full">
        
<article class="post">
  
  <div class="container">
    <header class="post-header">
      <h1 class="post-title">ICS_PA2 å®éªŒæŠ¥å‘Š</h1>
      <div class="post-meta">
        <time class="post-date" datetime="2025-11-11T14:58:52Z">2025å¹´11æœˆ11æ—¥</time>
        
          <span class="post-categories">
            
              <a href="/categories/%E6%8A%A5%E5%91%8A/" class="category-link">æŠ¥å‘Š</a>
            
          </span>
        
        
          <span class="post-wordcount">1771 å­—</span>
        
      </div>
    </header>
    
    <div class="post-body">
      
        <aside class="post-toc">
          <div class="toc-header">
            <span class="toc-title">ç›®å½•</span>
          </div>
          <div class="toc-content">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#å®éªŒè¿›åº¦">å®éªŒè¿›åº¦</a></li>
    <li><a href="#å¿…ç­”é¢˜">å¿…ç­”é¢˜</a>
      <ul>
        <li><a href="#ä¸åœè®¡ç®—çš„æœºå™¨">ä¸åœè®¡ç®—çš„æœºå™¨</a></li>
        <li><a href="#rtfsc2">RTFSC(2)</a></li>
        <li><a href="#ç¨‹åºå¦‚ä½•è¿è¡Œ">ç¨‹åºå¦‚ä½•è¿è¡Œ</a></li>
        <li><a href="#ç¼–è¯‘ä¸é“¾æ¥">ç¼–è¯‘ä¸é“¾æ¥</a></li>
        <li><a href="#äº†è§£makefile">äº†è§£Makefile</a></li>
      </ul>
    </li>
    <li><a href="#æ€è€ƒé¢˜">æ€è€ƒé¢˜</a></li>
    <li><a href="#æœ‰è¶£çš„ç¬é—´">æœ‰è¶£çš„ç¬é—´</a></li>
    <li><a href="#å®éªŒå¿ƒæƒ…">å®éªŒå¿ƒæƒ…</a></li>
  </ul>
</nav>
          </div>
        </aside>
      
      
      <div class="post-content">
        <h2 id="å®éªŒè¿›åº¦">å®éªŒè¿›åº¦</h2>
<p>æˆ‘å·²å®Œæˆ PA2 çš„<strong>æ‰€æœ‰å†…å®¹</strong>ï¼Œå¹¶é€šè¿‡äº†<strong>æ‰€æœ‰çš„æµ‹è¯•æ ·ä¾‹</strong>ã€‚</p>
<hr>
<h2 id="å¿…ç­”é¢˜">å¿…ç­”é¢˜</h2>
<h3 id="ä¸åœè®¡ç®—çš„æœºå™¨">ä¸åœè®¡ç®—çš„æœºå™¨</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define NREG 4
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NMEM 16
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// å®šä¹‰æŒ‡ä»¤æ ¼å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="p">{</span> <span class="kt">uint8_t</span> <span class="nl">rs</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">rt</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">op</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span> <span class="n">rtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="p">{</span> <span class="kt">uint8_t</span> <span class="nl">addr</span> <span class="p">:</span> <span class="mi">4</span>      <span class="p">,</span> <span class="nl">op</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">inst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">inst_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define DECODE_R(inst) uint8_t rt = (inst).rtype.rt, rs = (inst).rtype.rs
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DECODE_M(inst) uint8_t addr = (inst).mtype.addr
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// PC, Cè¯­è¨€ä¸­æ²¡æœ‰4ä½çš„æ•°æ®ç±»å‹, æˆ‘ä»¬é‡‡ç”¨8ä½ç±»å‹æ¥è¡¨ç¤º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint8_t</span> <span class="n">R</span><span class="p">[</span><span class="n">NREG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint8_t</span> <span class="n">M</span><span class="p">[</span><span class="n">NMEM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1">// å†…å­˜, å…¶ä¸­åŒ…å«ä¸€ä¸ªè®¡ç®—z = x + yçš„ç¨‹åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b11100110</span><span class="p">,</span>  <span class="c1">// load  6#     | R[0] &lt;- M[y]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b00000100</span><span class="p">,</span>  <span class="c1">// mov   r1, r0 | R[1] &lt;- R[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b11100101</span><span class="p">,</span>  <span class="c1">// load  5#     | R[0] &lt;- M[x]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b00010001</span><span class="p">,</span>  <span class="c1">// add   r0, r1 | R[0] &lt;- R[0] + R[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b11110111</span><span class="p">,</span>  <span class="c1">// store 7#     | M[z] &lt;- R[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b00010000</span><span class="p">,</span>  <span class="c1">// x = 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b00100001</span><span class="p">,</span>  <span class="c1">// y = 33
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="mi">0</span><span class="n">b00000000</span><span class="p">,</span>  <span class="c1">// z = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">halt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// ç»“æŸæ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ‰§è¡Œä¸€æ¡æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">exec_once</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">inst_t</span> <span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">this</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">pc</span><span class="p">];</span> <span class="c1">// å–æŒ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">rtype</span><span class="p">.</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//  æ“ä½œç è¯‘ç        æ“ä½œæ•°è¯‘ç            æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="mi">0</span><span class="nl">b0000</span><span class="p">:</span> <span class="p">{</span> <span class="nf">DECODE_R</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="n">R</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span>   <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>   <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="nl">b0001</span><span class="p">:</span> <span class="p">{</span> <span class="nf">DECODE_R</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="n">R</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span>  <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>   <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="nl">b1110</span><span class="p">:</span> <span class="p">{</span> <span class="nf">DECODE_M</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="nl">b1111</span><span class="p">:</span> <span class="p">{</span> <span class="nf">DECODE_M</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="n">M</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>    <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid instruction with opcode = %x, halting...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">rtype</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pc</span> <span class="o">++</span><span class="p">;</span> <span class="c1">// æ›´æ–°PC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exec_once</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">halt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The result of 16 + 33 is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">M</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>é—®é¢˜ï¼š</strong> ç”»å‡ºåœ¨YEMUä¸Šæ‰§è¡Œçš„åŠ æ³•ç¨‹åºçš„çŠ¶æ€æœº</p>
<p><strong>Solution:</strong></p>
<p>$$\begin{aligned}
\text{State}_0 &amp;: (PC=0, R[0]=0, R[1]=0, M[7]=0) \
&amp;\downarrow \text{ (load 6#: } R[0] \leftarrow 33) \
\text{State}_1 &amp;: (PC=1, R[0]=33, R[1]=0, M[7]=0) \
&amp;\downarrow \text{ (mov r1, r0: } R[1] \leftarrow 33) \
\text{State}_2 &amp;: (PC=2, R[0]=33, R[1]=33, M[7]=0) \
&amp;\downarrow \text{ (load 5#: } R[0] \leftarrow 16) \
\text{State}_3 &amp;: (PC=3, R[0]=16, R[1]=33, M[7]=0) \
&amp;\downarrow \text{ (add r0, r1: } R[0] \leftarrow 16+33=49) \
\text{State}_4 &amp;: (PC=4, R[0]=49, R[1]=33, M[7]=0) \
&amp;\downarrow \text{ (store 7#: } M[7] \leftarrow 49) \
\text{State}_5 &amp;: (PC=5, R[0]=49, R[1]=33, M[7]=49) \
\end{aligned}$$</p>
<p><strong>é—®é¢˜ï¼š</strong> é€šè¿‡RTFSCç†è§£YEMUå¦‚ä½•æ‰§è¡Œä¸€æ¡æŒ‡ä»¤</p>
<p><strong>Solution:</strong></p>
<p>YEMUçš„æŒ‡ä»¤æ‰§è¡Œå‘¨æœŸï¼ˆåœ¨ <code>exec_once()</code> å‡½æ•°ä¸­ï¼‰éµå¾ªç»å…¸çš„å†¯Â·è¯ºä¾æ›¼å‘¨æœŸï¼š<strong>å–æŒ‡ (Fetch)</strong> -&gt; <strong>è¯‘ç  (Decode)</strong> -&gt; <strong>æ‰§è¡Œ (Execute)</strong> -&gt; <strong>æ›´æ–°PC (Update PC)</strong>ã€‚</p>
<p>** 1. å–æŒ‡ (Fetch)**</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="kt">inst_t</span> <span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">this</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">pc</span><span class="p">];</span> <span class="c1">// å–æŒ‡
</span></span></span></code></pre></div><ul>
<li>æŒ‡ä»¤å­˜å‚¨åœ¨å†…å­˜ <code>M</code> ä¸­ã€‚</li>
<li>ç¨‹åºè®¡æ•°å™¨ <code>pc</code> ç»™å‡ºä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚</li>
<li><code>M[pc]</code> çš„å†…å®¹ï¼ˆä¸€ä¸ª $\text{uint8_t}$ å€¼ï¼‰è¢«å–å‡ºå¹¶å­˜å‚¨åœ¨ <code>this</code> è”åˆä½“ä¸­ã€‚</li>
</ul>
<p>** 2. è¯‘ç  (Decode) å’Œ æ‰§è¡Œ (Execute)**</p>
<p>æŒ‡ä»¤çš„è¯‘ç å’Œæ‰§è¡Œæ˜¯é€šè¿‡ <code>switch (this.rtype.op)</code> ç»“æ„å®Œæˆçš„ï¼Œå®ƒé¦–å…ˆé€šè¿‡ <code>inst_t</code> è”åˆä½“çš„ <code>rtype</code> ç»“æ„ä½“å­—æ®µ <code>op</code> æå–<strong>æ“ä½œç  (Opcode)</strong>ã€‚</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Opcode (<code>this.rtype.op</code>)</th>
          <th style="text-align: center">æŒ‡ä»¤ç±»å‹</th>
          <th style="text-align: center">è¯‘ç å® (Operands)</th>
          <th style="text-align: center">æ‰§è¡Œæ“ä½œ (Execution)</th>
          <th style="text-align: center">æ±‡ç¼–æŒ‡ä»¤</th>
          <th style="text-align: left">å«ä¹‰</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">$\text{0b0000}$ (0)</td>
          <td style="text-align: center">R-type</td>
          <td style="text-align: center"><code>DECODE_R</code> ($r_t, r_s$)</td>
          <td style="text-align: center">$R[r_t] = R[r_s]$</td>
          <td style="text-align: center"><code>mov rt, rs</code></td>
          <td style="text-align: left">å¯„å­˜å™¨é—´ä¼ è¾“</td>
      </tr>
      <tr>
          <td style="text-align: center">$\text{0b0001}$ (1)</td>
          <td style="text-align: center">R-type</td>
          <td style="text-align: center"><code>DECODE_R</code> ($r_t, r_s$)</td>
          <td style="text-align: center">$R[r_t] += R[r_s]$</td>
          <td style="text-align: center"><code>add rt, rs</code></td>
          <td style="text-align: left">å¯„å­˜å™¨åŠ æ³•</td>
      </tr>
      <tr>
          <td style="text-align: center">$\text{0b1110}$ (14)</td>
          <td style="text-align: center">M-type</td>
          <td style="text-align: center"><code>DECODE_M</code> ($addr$)</td>
          <td style="text-align: center">$R[0] = M[addr]$</td>
          <td style="text-align: center"><code>load addr\#</code></td>
          <td style="text-align: left"><strong>ä»å†…å­˜åŠ è½½åˆ° $R[0]$</strong></td>
      </tr>
      <tr>
          <td style="text-align: center">$\text{0b1111}$ (15)</td>
          <td style="text-align: center">M-type</td>
          <td style="text-align: center"><code>DECODE_M</code> ($addr$)</td>
          <td style="text-align: center">$M[addr] = R[0]$</td>
          <td style="text-align: center"><code>store addr\#</code></td>
          <td style="text-align: left"><strong>ä» $R[0]$ å­˜å‚¨åˆ°å†…å­˜</strong></td>
      </tr>
  </tbody>
</table>
<ul>
<li><strong>R-type æŒ‡ä»¤</strong> (<code>mov</code>, <code>add</code>): ä½¿ç”¨ $r_type$ ç»“æ„ä½“çš„ $r_t$ (ç›®æ ‡å¯„å­˜å™¨) å’Œ $r_s$ (æºå¯„å­˜å™¨) å­—æ®µæ¥æ“ä½œå¯„å­˜å™¨ $R[]$ ä¸­çš„å€¼ã€‚</li>
<li><strong>M-type æŒ‡ä»¤</strong> (<code>load</code>, <code>store</code>): ä½¿ç”¨ $m_type$ ç»“æ„ä½“çš„ $addr$ (å†…å­˜åœ°å€) å­—æ®µæ¥æ“ä½œå†…å­˜ $M[]$ å’Œå¯„å­˜å™¨ $R[0]$ (éšå«ç›®æ ‡/æº)ã€‚</li>
</ul>
<p>** 3. é”™è¯¯å¤„ç† (Invalid Opcode)**</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid instruction with opcode = %x, halting...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">rtype</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></div><ul>
<li>å¦‚æœå–å‡ºçš„æŒ‡ä»¤çš„æ“ä½œç ä¸åŒ¹é…ä»»ä½•å·²å®šä¹‰çš„æŒ‡ä»¤ï¼ˆ0, 1, 14, 15ï¼‰ï¼Œåˆ™<strong>è®¾ç½® <code>halt = 1</code> æ ‡å¿—å¹¶æ‰“å°é”™è¯¯ä¿¡æ¯</strong>ï¼Œä»è€Œå¯¼è‡´ç¨‹åºåœæ­¢è¿è¡Œã€‚</li>
</ul>
<p>** 4. æ›´æ–°PC (Update PC)**</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">pc</span> <span class="o">++</span><span class="p">;</span> <span class="c1">// æ›´æ–°PC
</span></span></span></code></pre></div><ul>
<li>æ— è®ºæ˜¯æˆåŠŸæ‰§è¡Œäº†ä¸€æ¡æŒ‡ä»¤ï¼Œè¿˜æ˜¯é‡åˆ°äº†æ— æ•ˆæŒ‡ä»¤å¹¶è®¾ç½®äº† <code>halt</code> æ ‡å¿—ï¼Œ<strong>ç¨‹åºè®¡æ•°å™¨ <code>pc</code> éƒ½ä¼šç®€å•åœ°é€’å¢ 1</strong>ï¼ŒæŒ‡å‘å†…å­˜ä¸­çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚</li>
</ul>
<h3 id="rtfsc2">RTFSC(2)</h3>
<p><strong>é—®é¢˜ï¼š</strong> è¯·æ•´ç†ä¸€æ¡æŒ‡ä»¤åœ¨NEMUä¸­çš„æ‰§è¡Œè¿‡ç¨‹</p>
<p><strong>Solution</strong>
<strong>æŒ‡ä»¤æ‰§è¡Œæµç¨‹</strong></p>
<p>1. <strong>å¯åŠ¨æ‰§è¡Œ (<code>cpu_exec</code>)</strong></p>
<ul>
<li>
<p><code>cpu_exec(uint64_t n)</code>: è¿™æ˜¯ CPU æ¨¡æ‹Ÿçš„å…¥å£å‡½æ•°ï¼Œæ¥æ”¶è¦æ‰§è¡Œçš„æŒ‡ä»¤æ•°é‡ $n$ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cpu_exec</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_print_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">MAX_INST_TO_PRINT</span><span class="p">);</span> <span class="c1">// ITRAC/si å‘½ä»¤çš„æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">NEMU_END</span><span class="p">:</span> <span class="k">case</span> <span class="nl">NEMU_ABORT</span><span class="p">:</span> <span class="k">case</span> <span class="nl">NEMU_QUIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* ... çŠ¶æ€æ£€æŸ¥ ... */</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">NEMU_RUNNING</span><span class="p">;</span> <span class="c1">// è®¾ç½®è¿è¡ŒçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">timer_start</span> <span class="o">=</span> <span class="nf">get_time</span><span class="p">();</span> <span class="c1">// è®°å½•èµ·å§‹æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">execute</span><span class="p">(</span><span class="n">n</span><span class="p">);</span> <span class="c1">// **è¿›å…¥æ‰§è¡Œå¾ªç¯**
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">timer_end</span> <span class="o">=</span> <span class="nf">get_time</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_timer</span> <span class="o">+=</span> <span class="n">timer_end</span> <span class="o">-</span> <span class="n">timer_start</span><span class="p">;</span> <span class="c1">// æ›´æ–°è€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... ç»“æŸçŠ¶æ€å¤„ç†å’Œç»Ÿè®¡ ... */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<p>2. <strong>æ‰§è¡Œå¾ªç¯ (<code>execute</code>)</strong></p>
<ul>
<li>
<p><code>execute(uint64_t n)</code>: å¾ªç¯ $n$ æ¬¡ï¼Œåœ¨æ¯æ¬¡è¿­ä»£ä¸­æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">execute</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Decode</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exec_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span> <span class="c1">// æ‰§è¡Œå•æ¡æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">g_nr_guest_inst</span> <span class="o">++</span><span class="p">;</span> <span class="c1">// æŒ‡ä»¤è®¡æ•°æ›´æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">trace_and_difftest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span> <span class="c1">// è¿½è¸ªã€å¯¹æ¯”ã€æ£€æŸ¥ç›‘è§†ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NEMU_RUNNING</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// æ£€æŸ¥çŠ¶æ€ï¼Œè‹¥æš‚åœ/ç»“æŸåˆ™é€€å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">IFDEF</span><span class="p">(</span><span class="n">CONFIG_DEVICE</span><span class="p">,</span> <span class="nf">device_update</span><span class="p">());</span> <span class="c1">// è®¾å¤‡æ›´æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<p>3. <strong>å•æ­¥æ‰§è¡Œ (<code>exec_once</code>)</strong></p>
<p>è¿™æ˜¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„æ ¸å¿ƒæ­¥éª¤ï¼š</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">æ­¥éª¤</th>
          <th style="text-align: left">å‡½æ•°/å®</th>
          <th style="text-align: left">æè¿°</th>
          <th style="text-align: left">å¯¹åº”çš„ä»£ç ç‰‡æ®µ (<code>exec_once</code>)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>I. è®¾ç½® PC</strong></td>
          <td style="text-align: left"><code>s-&gt;pc = pc;</code></td>
          <td style="text-align: left">å°†å½“å‰çš„ <strong>ç¨‹åºè®¡æ•°å™¨ (PC)</strong> å­˜å…¥ <code>Decode</code> ç»“æ„ä½“ $s$ ä¸­ã€‚</td>
          <td style="text-align: left"><code>s-&gt;pc = pc;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>II. æŒ‡ä»¤è§£ç ä¸æ‰§è¡Œ</strong></td>
          <td style="text-align: left"><code>isa_exec_once(s);</code></td>
          <td style="text-align: left"><strong>ISA ç›¸å…³æ“ä½œã€‚</strong> è´Ÿè´£å–æŒ‡ã€è§£ç ã€æ‰§è¡ŒæŒ‡ä»¤ï¼Œå¹¶è®¡ç®—å‡ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ (Next PC, <code>s-&gt;dnpc</code>)ã€‚</td>
          <td style="text-align: left"><code>isa_exec_once(s);</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>III. æ›´æ–° PC</strong></td>
          <td style="text-align: left"><code>cpu.pc = s-&gt;dnpc;</code></td>
          <td style="text-align: left">å°† CPU çš„å…¨å±€ PC æ›´æ–°ä¸ºæ‰§è¡Œç»“æœè®¡ç®—å‡ºçš„ <strong>ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</strong> (<code>s-&gt;dnpc</code>)ã€‚</td>
          <td style="text-align: left"><code>cpu.pc = s-&gt;dnpc;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>IV. FTRACE</strong></td>
          <td style="text-align: left"><code>CONFIG_FTRACE</code>, <code>ftrace_log(...)</code></td>
          <td style="text-align: left"><strong>å‡½æ•°è°ƒç”¨è¿½è¸ª</strong>ï¼šè®°å½•å‡½æ•°è°ƒç”¨å’Œè¿”å›ä¿¡æ¯ã€‚</td>
          <td style="text-align: left"><code>#ifdef CONFIG_FTRACE ... ftrace_log(...) ... #endif</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>V. ITRACE/IRINGBUF</strong></td>
          <td style="text-align: left"><code>CONFIG_ITRACE</code>, <code>push_iringbuf(...)</code></td>
          <td style="text-align: left"><strong>æŒ‡ä»¤è¿½è¸ª</strong>ï¼šæ ¼å¼åŒ–æŒ‡ä»¤ä¿¡æ¯ï¼ˆæœºå™¨ç ã€æ±‡ç¼–ï¼‰å¹¶å­˜å…¥æ—¥å¿—ç¼“å†²åŒº <code>s-&gt;logbuf</code>ï¼Œç„¶åæ¨å…¥ç¯å½¢ç¼“å†²åŒºã€‚</td>
          <td style="text-align: left"><code>#ifdef CONFIG_ITRACE ... disassemble(...) ... push_iringbuf(...) ... #endif</code></td>
      </tr>
  </tbody>
</table>
<hr>
<p>4. <strong>è¿½è¸ªä¸æ£€æŸ¥ (<code>trace_and_difftest</code>)</strong></p>
<p>åœ¨ <code>exec_once</code> ä¹‹åï¼Œ<code>execute</code> å‡½æ•°è°ƒç”¨ <code>trace_and_difftest</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_and_difftest</span><span class="p">(</span><span class="n">Decode</span> <span class="o">*</span><span class="n">_this</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">dnpc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_ITRACE_COND </span><span class="c1">// CONFIG_ITRACE_COND é…ç½®çš„è¿½è¸ªæ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ITRACE_COND</span><span class="p">)</span> <span class="p">{</span> <span class="nf">log_write</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_this</span><span class="o">-&gt;</span><span class="n">logbuf</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">g_print_step</span><span class="p">)</span> <span class="p">{</span> <span class="nf">IFDEF</span><span class="p">(</span><span class="n">CONFIG_ITRACE</span><span class="p">,</span> <span class="nf">puts</span><span class="p">(</span><span class="n">_this</span><span class="o">-&gt;</span><span class="n">logbuf</span><span class="p">));</span> <span class="p">}</span> <span class="c1">// MAX_INST_TO_PRINT æ§åˆ¶çš„å•æ­¥è¾“å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">  <span class="nf">IFDEF</span><span class="p">(</span><span class="n">CONFIG_DIFFTEST</span><span class="p">,</span> <span class="nf">difftest_step</span><span class="p">(</span><span class="n">_this</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">dnpc</span><span class="p">));</span> <span class="c1">// **åŒæœºå¯¹æ¯”**
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_WATCHPOINT </span><span class="c1">// **ç›‘è§†ç‚¹æ£€æŸ¥**
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">check_watchpoints</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">NEMU_STOP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Watchpoint triggered!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span></code></pre></div><p>5. <strong>çŠ¶æ€æ›´æ–°</strong></p>
<ul>
<li><strong>æŒ‡ä»¤è®¡æ•°æ›´æ–°</strong>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">g_nr_guest_inst</span> <span class="o">++</span><span class="p">;</span>
</span></span></code></pre></div></li>
<li><strong>çŠ¶æ€æ£€æŸ¥</strong>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NEMU_RUNNING</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></div></li>
<li><strong>è®¾å¤‡æ›´æ–° (DEVICE)</strong>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">IFDEF</span><span class="p">(</span><span class="n">CONFIG_DEVICE</span><span class="p">,</span> <span class="nf">device_update</span><span class="p">());</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<p>6. <strong>ç»“æŸç»Ÿè®¡</strong></p>
<ul>
<li>
<p>æ‰§è¡Œå¾ªç¯ç»“æŸåï¼Œ<code>cpu_exec</code> å‡½æ•°ç»§ç»­æ‰§è¡Œï¼Œå¹¶æ ¹æ®æœ€ç»ˆçš„ <code>nemu_state.state</code> å†³å®šåç»­åŠ¨ä½œï¼Œæœ€ç»ˆè°ƒç”¨ <code>statistic()</code> æ‰“å°ç»Ÿè®¡æ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// cpu_exec
</span></span></span><span class="line"><span class="cl"><span class="c1">// ... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">switch</span> <span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">NEMU_RUNNING</span><span class="p">:</span> <span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">NEMU_STOP</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// æ‰§è¡Œå®Œæ¯• n æ¡æŒ‡ä»¤åï¼Œè®¾ä¸º NEMU_STOP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">NEMU_END</span><span class="p">:</span> <span class="k">case</span> <span class="nl">NEMU_ABORT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Log</span><span class="p">(</span><span class="s">&#34;nemu: %s at pc = &#34;</span> <span class="n">FMT_WORD</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// fall through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">case</span> <span class="nl">NEMU_QUIT</span><span class="p">:</span> <span class="nf">statistic</span><span class="p">();</span> <span class="c1">// é‡åˆ° END/ABORT/QUIT åˆ™æ‰“å°ç»Ÿè®¡æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<p><strong>å…³é”®æ•°æ®ç»“æ„</strong></p>
<ul>
<li>
<p><strong><code>CPU_state cpu</code></strong>: å…¨å±€å˜é‡ï¼Œå­˜å‚¨ CPU å¯„å­˜å™¨çŠ¶æ€å’Œ <code>pc</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">CPU_state</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">{};</span>
</span></span></code></pre></div></li>
<li>
<p><strong><code>Decode s</code></strong>: å±€éƒ¨å˜é‡ï¼Œç”¨äºå­˜å‚¨<strong>å•æ¡</strong>æŒ‡ä»¤çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Decode</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// åœ¨ execute å‡½æ•°å†…å±€éƒ¨å£°æ˜
</span></span></span></code></pre></div></li>
</ul>
<h3 id="ç¨‹åºå¦‚ä½•è¿è¡Œ">ç¨‹åºå¦‚ä½•è¿è¡Œ</h3>
<p><strong>é—®é¢˜ï¼š</strong> è¯·ä½ ä»¥æ‰“å­—å°æ¸¸æˆä¸ºä¾‹, ç»“åˆ&quot;ç¨‹åºåœ¨è®¡ç®—æœºä¸Šè¿è¡Œ&quot;çš„ä¸¤ä¸ªè§†è§’, æ¥å‰–ææ‰“å­—å°æ¸¸æˆç©¶ç«Ÿæ˜¯å¦‚ä½•åœ¨è®¡ç®—æœºä¸Šè¿è¡Œçš„. å…·ä½“åœ°, å½“ä½ æŒ‰ä¸‹ä¸€ä¸ªå­—æ¯å¹¶å‘½ä¸­çš„æ—¶å€™, æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿ(NEMU, ISA, AM, è¿è¡Œæ—¶ç¯å¢ƒ, ç¨‹åº) æ˜¯å¦‚ä½•ååŒå·¥ä½œ, ä»è€Œè®©æ‰“å­—å°æ¸¸æˆå®ç°å‡º&quot;å‘½ä¸­&quot;çš„æ¸¸æˆæ•ˆæœ?</p>
<p><strong>Solution</strong>
<img src="Typing_Game.png" alt="Typing Game">
<strong>å¾®è§‚è§†è§’(ç¨‹åº)</strong>
1. <strong>ç¨‹åºç»“æ„å’Œé€»è¾‘</strong></p>
<p>æ‰“å­—å°æ¸¸æˆçš„æ ¸å¿ƒæ˜¯<strong>äº‹ä»¶é©±åŠ¨</strong>å’Œ<strong>å¸§åŒæ­¥</strong>çš„å¾ªç¯ï¼š</p>
<ul>
<li><strong>æ•°æ®ç»“æ„:</strong> <code>struct character chars[NCHAR]</code> å­˜å‚¨äº†å±å¹•ä¸Šæ¯ä¸ªä¸‹è½å­—æ¯çš„çŠ¶æ€ï¼ˆå­—ç¬¦ã€ä½ç½® <code>x, y</code>ã€é€Ÿåº¦ <code>v</code>ã€çŠ¶æ€è®¡æ—¶ <code>t</code>ï¼‰ã€‚</li>
<li><strong>æ¸¸æˆä¸»å¾ªç¯ (<code>main</code>):</strong>
<ul>
<li>é€šè¿‡ <code>io_read(AM_TIMER_UPTIME).us</code> è·å–å½“å‰æ—¶é—´ï¼Œè®¡ç®—å‡ºåº”è¯¥æ¸²æŸ“çš„å¸§æ•° (<code>frames</code>)ï¼Œå®ç°<strong>å¸§åŒæ­¥</strong>ã€‚</li>
<li><strong>æ›´æ–°é€»è¾‘ (<code>game_logic_update</code>):</strong> åœ¨ <code>current &lt; frames</code> çš„å¾ªç¯ä¸­ï¼Œæ¨¡æ‹Ÿå­—æ¯ä¸‹è½ã€ç”Ÿæˆæ–°å­—æ¯ã€åˆ¤æ–­è¾“å…¥å­—æ¯æ˜¯å¦æ­£ç¡®ç­‰æ¸¸æˆé€»è¾‘ã€‚</li>
<li><strong>è¾“å…¥å¤„ç† (<code>io_read(AM_INPUT_KEYBRD)</code>):</strong> å¾ªç¯è¯»å–é”®ç›˜äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ <code>check_hit</code> å‡½æ•°å¤„ç†æŒ‰é”®ã€‚</li>
<li><strong>æ¸²æŸ“ (<code>render</code>):</strong> å½“æœ‰æ–°çš„é€»è¾‘æ›´æ–°æ—¶ (<code>current &gt; rendered</code>)ï¼Œè°ƒç”¨ <code>render</code> å°†æ–°çš„æ¸¸æˆçŠ¶æ€ç»˜åˆ¶åˆ°å±å¹•ã€‚</li>
</ul>
</li>
</ul>
<p>2. <strong>â€œå‘½ä¸­â€äº‹ä»¶çš„ç¨‹åºé€»è¾‘</strong></p>
<p>å½“æŒ‰ä¸‹é”®ç›˜ä¸Šä¸€ä¸ªå­—æ¯ï¼ˆå¦‚ &lsquo;A&rsquo;ï¼‰æ—¶ï¼š</p>
<ol>
<li>
<p><strong>è¯»å–è¾“å…¥:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// main å‡½æ•°ä¸­çš„è¾“å…¥å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">AM_INPUT_KEYBRD_T</span> <span class="n">ev</span> <span class="o">=</span> <span class="nf">io_read</span><span class="p">(</span><span class="n">AM_INPUT_KEYBRD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">keydown</span> <span class="o">&amp;&amp;</span> <span class="n">lut</span><span class="p">[</span><span class="n">ev</span><span class="p">.</span><span class="n">keycode</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">check_hit</span><span class="p">(</span><span class="n">lut</span><span class="p">[</span><span class="n">ev</span><span class="p">.</span><span class="n">keycode</span><span class="p">]);</span> <span class="c1">// è°ƒç”¨å‘½ä¸­æ£€æµ‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ç¨‹åºé€šè¿‡ <code>io_read(AM_INPUT_KEYBRD)</code> æ¥å£ä»æŠ½è±¡çš„<strong>è¾“å…¥è®¾å¤‡</strong>è·å–æŒ‰é”®äº‹ä»¶ (<code>ev</code>)ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„<strong>æŒ‰ä¸‹</strong>äº‹ä»¶ (<code>ev.keydown</code>)ï¼Œåˆ™å°†åŸå§‹é”®ç  (<code>ev.keycode</code>) é€šè¿‡æŸ¥æ‰¾è¡¨ <code>lut</code> è½¬æ¢ä¸ºå­—ç¬¦ï¼Œå¹¶ä¼ é€’ç»™ <code>check_hit</code>ã€‚</p>
</li>
<li>
<p><strong>å‘½ä¸­æ£€æµ‹å’Œæ›´æ–°çŠ¶æ€ (<code>check_hit</code>):</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">check_hit</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// éå†æ‰€æœ‰å­—æ¯ï¼Œæ‰¾åˆ°ä¸æŒ‰é”®åŒ¹é…ä¸”æ­£åœ¨ä¸‹è½çš„**æœ€é ä¸‹**çš„å­—æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ... æ‰¾åˆ°å‘½ä¸­çš„å­—æ¯ç´¢å¼• m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">wrong</span><span class="o">++</span><span class="p">;</span> <span class="c1">// æœªå‘½ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hit</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">chars</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">screen_h</span> <span class="o">-</span> <span class="n">CHAR_H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">FPS</span><span class="p">);</span> <span class="c1">// å…³é”®ï¼šé€Ÿåº¦è®¾ä¸ºè´Ÿå€¼ï¼Œä½¿å…¶å‘ä¸Šé£å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>ç¨‹åºéå† <code>chars</code> æ•°ç»„ï¼Œå¯»æ‰¾å­—ç¬¦ <code>c-&gt;ch</code> ä¸æŒ‰é”® <code>ch</code> ç›¸åŒï¼Œå¹¶ä¸”é€Ÿåº¦ <code>c-&gt;v &gt; 0</code>ï¼ˆå³<strong>æ­£åœ¨ä¸‹è½</strong>ï¼‰çš„å­—æ¯ã€‚</li>
<li>ä¸ºäº†ç¬¦åˆâ€œæ‰“ä¸­<strong>æœ€å¿«è¦æ‰è½çš„</strong>â€çš„æ¸¸æˆè§„åˆ™ï¼Œå®ƒæ‰¾åˆ°çš„æ˜¯<strong>æœ€é ä¸‹</strong> (<code>c-&gt;y</code> æœ€å¤§) çš„é‚£ä¸ªã€‚</li>
<li><strong>å‘½ä¸­æ•ˆæœå®ç°:</strong> å°†è¢«å‡»ä¸­å­—æ¯çš„é€Ÿåº¦ <code>chars[m].v</code> è®¾ç½®ä¸ºä¸€ä¸ª<strong>è´Ÿå€¼</strong>ï¼Œä½¿å…¶å¼€å§‹<strong>å‘ä¸Šé£å‡º</strong>ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ¸²æŸ“å‘½ä¸­æ•ˆæœ (<code>render</code>):</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// render å‡½æ•°ä¸­å†³å®šç»˜åˆ¶é¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nl">WHITE</span> <span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">GREEN</span> <span class="p">:</span> <span class="n">RED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">io_write</span><span class="p">(</span><span class="n">AM_GPU_FBDRAW</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">texture</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">-</span> <span class="sc">&#39;A&#39;</span><span class="p">],</span> <span class="n">CHAR_W</span><span class="p">,</span> <span class="n">CHAR_H</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span></code></pre></div><p>åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸï¼Œç”±äºè¢«å‘½ä¸­çš„å­—æ¯ <code>c</code> çš„é€Ÿåº¦ <code>c-&gt;v &lt; 0</code>ï¼Œ<code>render</code> å‡½æ•°ä¼šä¸ºå…¶é€‰æ‹© <code>GREEN</code> é¢œè‰²ï¼Œå¹¶ä½¿ç”¨ <code>io_write(AM_GPU_FBDRAW)</code> å°†å…¶ç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼Œä»è€Œå®ç°äº†â€œå­—æ¯å˜ç»¿å‘ä¸Šé£å‡ºâ€çš„<strong>å‘½ä¸­è§†è§‰æ•ˆæœ</strong>ã€‚</p>
</li>
</ol>
<hr>
<p><strong>å®è§‚è§†è§’</strong></p>
<p>1. <strong>æŠ½è±¡ä¸­é—´å±‚ (AM)</strong></p>
<p><strong>AM (Abstract Machine)</strong> æä¾›äº†ä¸åº•å±‚ç¡¬ä»¶æŠ½è±¡æ¥å£ï¼Œæ˜¯è¿æ¥ä¸Šå±‚ç¨‹åºå’Œåº•å±‚ç¡¬ä»¶/æ¨¡æ‹Ÿå™¨çš„æ¡¥æ¢ã€‚</p>
<ul>
<li>
<p><strong>è¾“å…¥æŠ½è±¡:</strong></p>
<ul>
<li><code>AM_INPUT_KEYBRD</code> æ˜¯å¯¹<strong>é”®ç›˜ç¡¬ä»¶</strong>çš„æŠ½è±¡ã€‚</li>
<li>å½“ç¨‹åºè°ƒç”¨ <code>io_read(AM_INPUT_KEYBRD)</code> æ—¶ï¼ŒAM ä¼šè´Ÿè´£ä¸<strong>é”®ç›˜è®¾å¤‡</strong>äº¤äº’ï¼Œè·å–æŒ‰é”®çš„<strong>é”®ç </strong>å’Œ<strong>çŠ¶æ€</strong>ï¼ˆæŒ‰ä¸‹/æ¾å¼€ï¼‰ï¼Œå¹¶ä»¥ç»Ÿä¸€çš„ <code>AM_INPUT_KEYBRD_T</code> ç»“æ„ä½“å½¢å¼è¿”å›ç»™ç¨‹åºã€‚</li>
</ul>
</li>
<li>
<p><strong>å›¾å½¢æŠ½è±¡:</strong></p>
<ul>
<li><code>AM_GPU_FBDRAW</code> æ˜¯å¯¹<strong>æ˜¾å¡å¸§ç¼“å†²åŒº (Framebuffer)</strong> çš„æŠ½è±¡ã€‚</li>
<li>å½“ç¨‹åºè°ƒç”¨ <code>io_write(AM_GPU_FBDRAW, ...)</code> æ—¶ï¼ŒAM ä¼šè´Ÿè´£å°†åƒç´ æ•°æ®å†™å…¥æ˜¾å¡çš„å†…å­˜åŒºåŸŸï¼Œé©±åŠ¨æ˜¾ç¤ºæ›´æ–°ã€‚</li>
</ul>
</li>
</ul>
<p>2. <strong>æŒ‡ä»¤é›†æ¶æ„ (ISA)</strong></p>
<p>æ— è®ºæ˜¯ç¨‹åºé€»è¾‘ (<code>check_hit</code> ä¸­çš„æ¯”è¾ƒå’Œèµ‹å€¼) è¿˜æ˜¯ AM æ¥å£çš„è°ƒç”¨ï¼Œæœ€ç»ˆéƒ½ç¼–è¯‘æˆç›®æ ‡ ISAï¼ˆå¦‚ RISC-Vï¼‰çš„<strong>æœºå™¨æŒ‡ä»¤</strong>ã€‚</p>
<ul>
<li>ä¾‹å¦‚ï¼Œåœ¨ <code>check_hit</code> ä¸­å°†é€Ÿåº¦è®¾ç½®ä¸ºè´Ÿæ•°çš„ C ä»£ç ï¼š
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">chars</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">screen_h</span> <span class="o">-</span> <span class="n">CHAR_H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">FPS</span><span class="p">);</span>
</span></span></code></pre></div>å°†è¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆä¸€ç³»åˆ—çš„ ISA æŒ‡ä»¤ï¼ˆå¦‚åŠ è½½ã€å‡æ³•ã€é™¤æ³•ã€å–åã€å­˜å‚¨ç­‰ï¼‰ï¼Œé€šè¿‡è¿™äº›æŒ‡ä»¤è¿™äº›æŒ‡ä»¤æ“ä½œ<strong>å¯„å­˜å™¨</strong>å’Œ<strong>å†…å­˜</strong>ã€‚</li>
</ul>
<p>3. <strong>æ‰§è¡Œç¯å¢ƒ (NEMU)</strong></p>
<p><strong>NEMU (NJU EMUlator)</strong> æ˜¯ä¸€ä¸ª<strong>æŒ‡ä»¤é›†æ¨¡æ‹Ÿå™¨</strong>ï¼Œå®ƒè´Ÿè´£æ¨¡æ‹Ÿä¸€ä¸ªçœŸå® CPU çš„è¡Œä¸ºï¼Œæ‰§è¡Œä¸Šè¿° ISA æŒ‡ä»¤ã€‚</p>
<ul>
<li><strong>æ‰§è¡Œç¨‹åºé€»è¾‘:</strong> NEMU é€æ¡å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œï¼Œå®Œæˆ <code>check_hit</code> å†…éƒ¨çš„é€»è¾‘åˆ¤æ–­å’Œæ•°æ®ä¿®æ”¹ï¼ˆå¦‚ä¿®æ”¹ <code>chars[m].v</code> çš„å†…å­˜å€¼ï¼‰ã€‚</li>
<li><strong>æ¨¡æ‹Ÿ I/O äº¤äº’ (I/O Mapped Memory / Memory Mapped I/O):</strong>
<ul>
<li>å½“ç¨‹åºæ‰§è¡Œåˆ°æ¶‰åŠ <code>io_read</code> æˆ– <code>io_write</code> çš„æŒ‡ä»¤æ—¶ï¼Œå®ƒå®é™…ä¸Šæ˜¯åœ¨è®¿é—®ä¸€ä¸ª<strong>ç‰¹å®šçš„å†…å­˜åœ°å€</strong>ï¼ˆå³<strong>è®¾å¤‡å¯„å­˜å™¨</strong>ï¼‰ã€‚</li>
<li><strong>è¯»å–è¾“å…¥:</strong> å½“ NEMU å‘ç° CPU è¯•å›¾è¯»å–é”®ç›˜è®¾å¤‡å¯„å­˜å™¨æ—¶ï¼ˆé€šè¿‡ AM æŠ½è±¡ï¼‰ï¼ŒNEMU ä¼šæš‚åœæ¨¡æ‹Ÿï¼Œ<strong>æŸ¥è¯¢ä¸»æœºæ“ä½œç³»ç»Ÿçš„é”®ç›˜äº‹ä»¶</strong>ï¼Œå¹¶æ ¹æ®äº‹ä»¶çŠ¶æ€<strong>ä¼ªé€ </strong>ä¸€ä¸ªè®¾å¤‡è¿”å›å€¼ï¼ˆ<code>AM_INPUT_KEYBRD_T</code>ï¼‰ï¼Œæ¨¡æ‹Ÿé”®ç›˜æ•°æ®å‡†å¤‡å°±ç»ªã€‚</li>
<li><strong>æ¸²æŸ“è¾“å‡º:</strong> å½“ NEMU å‘ç° CPU è¯•å›¾å†™å…¥å¸§ç¼“å†²åŒºåœ°å€æ—¶ï¼ˆé€šè¿‡ <code>io_write(AM_GPU_FBDRAW, ...)</code>ï¼‰ï¼ŒNEMU ä¼šå°†è¯¥æ•°æ®<strong>è½¬å‘</strong>åˆ°<strong>ä¸»æœºæ“ä½œç³»ç»Ÿçš„å›¾å½¢ç•Œé¢</strong>ä¸Šï¼Œå®ç°å±å¹•åƒç´ çš„æ›´æ–°ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ç¼–è¯‘ä¸é“¾æ¥">ç¼–è¯‘ä¸é“¾æ¥</h3>
<p><strong>é—®é¢˜ï¼š</strong> åˆ†åˆ«å°è¯•å»æ‰static, å»æ‰inlineæˆ–å»æ‰ä¸¤è€…, ç„¶åé‡æ–°è¿›è¡Œç¼–è¯‘,è¯·åˆ†åˆ«è§£é‡Šä¸ºä»€ä¹ˆè¿™äº›é”™è¯¯ä¼šå‘ç”Ÿ/ä¸å‘ç”Ÿ?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#ifndef __CPU_IFETCH_H__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory/vaddr.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="nf">inst_fetch</span><span class="p">(</span><span class="kt">vaddr_t</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">inst</span> <span class="o">=</span> <span class="nf">vaddr_ifetch</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">)</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">inst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></div><p><strong>Solution</strong>
<strong>å•ç‹¬å»æ‰ <code>static</code> (ä¿ç•™ <code>inline</code>)</strong></p>
<ul>
<li><strong>ç»“æœï¼š</strong> <strong>ä¸æŠ¥é”™</strong> (é“¾æ¥å™¨å¤„ç†)ã€‚</li>
<li><strong>åŸå› ï¼š</strong> <code>inline</code> å‡½æ•°åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰ä¸”ä¸ºå¤–éƒ¨é“¾æ¥ã€‚ç°ä»£é“¾æ¥å™¨ï¼ˆå¦‚ GNU ldï¼‰ä¼šå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ä¸­ç”Ÿæˆçš„å‡½æ•°å®šä¹‰è§†ä¸º<strong>å¼±ç¬¦å·</strong>ï¼Œå¹¶è‡ªåŠ¨é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºæœ€ç»ˆçš„å¤–éƒ¨å®šä¹‰ï¼Œé¿å…äº†å¤šé‡å®šä¹‰é”™è¯¯ã€‚</li>
</ul>
<p><strong>å•ç‹¬å»æ‰ <code>inline</code> (ä¿ç•™ <code>static</code>)</strong></p>
<ul>
<li><strong>ç»“æœï¼š</strong> <strong>ä¸æŠ¥é”™</strong> (å†…éƒ¨é“¾æ¥)ã€‚</li>
<li><strong>åŸå› ï¼š</strong> <code>static</code> å°†å‡½æ•°çš„é“¾æ¥æ€§é™åˆ¶ä¸º<strong>å†…éƒ¨é“¾æ¥</strong>ã€‚æ¯ä¸ªåŒ…å«è¯¥å¤´æ–‡ä»¶çš„ <code>.c</code> æ–‡ä»¶éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªè¯¥å‡½æ•°çš„ç§æœ‰å‰¯æœ¬ï¼Œäº’ç›¸éš”ç¦»ï¼Œé“¾æ¥å™¨çœ‹ä¸åˆ°å†²çªçš„ç¬¦å·ã€‚</li>
</ul>
<p><strong>åŒæ—¶å»æ‰ä¸¤è€…</strong></p>
<ul>
<li><strong>ç»“æœï¼š</strong> <strong>é“¾æ¥é”™è¯¯</strong>ã€‚</li>
<li><strong>åŸå› ï¼š</strong> å‡½æ•°æˆä¸ºä¸€ä¸ªæ™®é€šçš„<strong>å¤–éƒ¨é“¾æ¥</strong>å‡½æ•°ã€‚ç”±äºå¤´æ–‡ä»¶è¢«å¤šä¸ªæºæ–‡ä»¶åŒ…å«ï¼Œé“¾æ¥å™¨ä¼šåœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­å‘ç°å¤šä¸ªç›®æ ‡æ–‡ä»¶éƒ½å®šä¹‰äº†åŒåçš„<strong>å¼ºç¬¦å·</strong>ï¼Œè¿åäº† C è¯­è¨€çš„<strong>å•ä¸€å®šä¹‰åŸåˆ™</strong>ï¼ˆOne Definition Rule, ODRï¼‰ï¼Œå¯¼è‡´ <code>multiple definition</code> é“¾æ¥é”™è¯¯ã€‚</li>
</ul>
<p><strong>é—®é¢˜ï¼š</strong></p>
<ul>
<li>1.åœ¨nemu/inclu/common.hä¸­æ·»åŠ ä¸€è¡Œvolatile static int dummy; ç„¶åé‡æ–°ç¼–è¯‘NEMU. è¯·é—®é‡æ–°ç¼–è¯‘åçš„NEMUå«æœ‰å¤šå°‘ä¸ªdummyå˜é‡çš„å®ä½“? ä½ æ˜¯å¦‚ä½•å¾—åˆ°è¿™ä¸ªç»“æœçš„?</li>
<li>2.æ·»åŠ ä¸Šé¢˜ä¸­çš„ä»£ç å, å†åœ¨nemu/include/debug.hä¸­æ·»åŠ ä¸€è¡Œvolatile static int dummy; ç„¶åé‡æ–°ç¼–è¯‘NEMU. è¯·é—®æ­¤æ—¶çš„NEMUå«æœ‰å¤šå°‘ä¸ªdummyå˜é‡çš„å®ä½“? ä¸ä¸Šé¢˜ä¸­dummyå˜é‡å®ä½“æ•°ç›®è¿›è¡Œæ¯”è¾ƒ, å¹¶è§£é‡Šæœ¬é¢˜çš„ç»“æœ.</li>
<li>3.ä¿®æ”¹æ·»åŠ çš„ä»£ç , ä¸ºä¸¤å¤„dummyå˜é‡è¿›è¡Œåˆå§‹åŒ–:volatile static int dummy = 0; ç„¶åé‡æ–°ç¼–è¯‘NEMU. ä½ å‘ç°äº†ä»€ä¹ˆé—®é¢˜? ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰å‡ºç°è¿™æ ·çš„é—®é¢˜? (å›ç­”å®Œæœ¬é¢˜åå¯ä»¥åˆ é™¤æ·»åŠ çš„ä»£ç .)</li>
</ul>
<p><strong>Solution</strong></p>
<ul>
<li>1.æ·»åŠ ä»£ç å¹¶ç¼–è¯‘åï¼Œåœ¨nemuç›®å½•ä¸‹ç»ˆç«¯è¾“å…¥<code>nm -a build/riscv32-nemu-interpreter | grep dummy -c</code>è¿”å›36
<img src="dummy.png" alt=""></li>
<li>2.é‡å¤ä¸Šé—®æ­¥éª¤ï¼Œä¾æ—§è¿”å›36
<code>volatile static int dummy;</code>æœªåˆå§‹åŒ–çš„ç¼˜æ•…ï¼Œ<code>dummy</code>æ˜¯æš‚å®šå®šä¹‰ã€‚åœ¨å•ä¸ª .c æ–‡ä»¶ä¸­ï¼Œå³ä½¿é€šè¿‡åŒ…å«å¤šä¸ªå¤´æ–‡ä»¶çœ‹åˆ°å¤šæ¬¡ç›¸åŒçš„å®šä¹‰ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªå®ä½“ã€‚æ‰€ä»¥ä¾æ—§å«æœ‰36ä¸ªdummyå˜é‡çš„å®ä½“</li>
<li>3.æ·»åŠ ä»£ç åç¼–è¯‘å‡ºç°é”™è¯¯</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">  octopus@ICS:~/Projects/ics2025/nemu$ make
</span></span><span class="line"><span class="cl">+ CC src/nemu-main.c
</span></span><span class="line"><span class="cl">In file included from /home/octopus/Projects/ics2025/nemu/include/utils.h:19,
</span></span><span class="line"><span class="cl">                 from /home/octopus/Projects/ics2025/nemu/include/debug.h:21,
</span></span><span class="line"><span class="cl">                 from /home/octopus/Projects/ics2025/nemu/include/common.h:47,
</span></span><span class="line"><span class="cl">                 from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/common.h:57:21: error: redefinition of â€˜dummyâ€™
</span></span><span class="line"><span class="cl">   <span class="m">57</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">In file included from /home/octopus/Projects/ics2025/nemu/include/debug.h:19,
</span></span><span class="line"><span class="cl">                 from /home/octopus/Projects/ics2025/nemu/include/common.h:47,
</span></span><span class="line"><span class="cl">                 from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/common.h:57:21: note: previous definition of â€˜dummyâ€™ was here
</span></span><span class="line"><span class="cl">   <span class="m">57</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">In file included from /home/octopus/Projects/ics2025/nemu/include/common.h:47,
</span></span><span class="line"><span class="cl">                 from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/debug.h:44:21: error: redefinition of â€˜dummyâ€™
</span></span><span class="line"><span class="cl">   <span class="m">44</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">In file included from /home/octopus/Projects/ics2025/nemu/include/utils.h:19,
</span></span><span class="line"><span class="cl">                 from /home/octopus/Projects/ics2025/nemu/include/debug.h:21,
</span></span><span class="line"><span class="cl">                 from /home/octopus/Projects/ics2025/nemu/include/common.h:47,
</span></span><span class="line"><span class="cl">                 from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/common.h:57:21: note: previous definition of â€˜dummyâ€™ was here
</span></span><span class="line"><span class="cl">   <span class="m">57</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">In file included from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/common.h:57:21: error: redefinition of â€˜dummyâ€™
</span></span><span class="line"><span class="cl">   <span class="m">57</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">In file included from /home/octopus/Projects/ics2025/nemu/include/common.h:47,
</span></span><span class="line"><span class="cl">                 from src/nemu-main.c:16:
</span></span><span class="line"><span class="cl">/home/octopus/Projects/ics2025/nemu/include/debug.h:44:21: note: previous definition of â€˜dummyâ€™ was here
</span></span><span class="line"><span class="cl">   <span class="m">44</span> <span class="p">|</span> volatile static int <span class="nv">dummy</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">|</span>                     ^~~~~
</span></span><span class="line"><span class="cl">make: *** <span class="o">[</span>/home/octopus/Projects/ics2025/nemu/scripts/build.mk:34: /home/octopus/Projects/ics2025/nemu/build/obj-riscv32-nemu-interpreter/src/nemu-main.o<span class="o">]</span> Error <span class="m">1</span>
</span></span><span class="line"><span class="cl">octopus@ICS:~/Projects/ics2025/nemu$ 
</span></span></code></pre></div><p>æœªåˆå§‹åŒ–æ—¶ä¸æŠ¥é”™ï¼Œè€Œç°åœ¨åˆå§‹åŒ–åæŠ¥é”™ï¼Œæ ¹æœ¬åŸå› åœ¨äºå˜é‡çš„å®šä¹‰æ–¹å¼ï¼š</p>
<ul>
<li>
<ol>
<li>
<p><strong>æœªåˆå§‹åŒ–æ—¶ï¼ˆ<code>volatile static int dummy;</code>ï¼‰ï¼š</strong></p>
<ul>
<li><code>dummy</code>ä¸ºæš‚å®šå®šä¹‰,å³æ²¡æœ‰å­˜å‚¨ç±»è¯´æ˜ç¬¦å’Œåˆå§‹åŒ–æ–¹æ³•çš„ä»»ä½•å¤–éƒ¨æ•°æ®å£°æ˜ã€‚</li>
<li>åœ¨åŒä¸€ä¸ªç¼–è¯‘å•å…ƒï¼ˆå•ä¸ª <code>.c</code> æ–‡ä»¶ç»è¿‡é¢„å¤„ç†åï¼‰å†…ï¼Œå¯ä»¥å‡ºç°åŒä¸€ä¸ªå˜é‡çš„å¤šä¸ªæš‚å®šå®šä¹‰ï¼Œç¼–è¯‘å™¨ä¼šå°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå˜é‡å®ä½“ã€‚å› æ­¤ï¼Œé‡å¤åŒ…å«å¤´æ–‡ä»¶ä¸ä¼šæŠ¥é”™ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>
<ol start="2">
<li>
<p><strong>åˆå§‹åŒ–åï¼ˆ<code>volatile static int dummy = 0;</code>ï¼‰ï¼š</strong></p>
<ul>
<li>å¯¹å…¨å±€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼ˆä¾‹å¦‚ <code>= 0</code>ï¼‰çš„è¡Œä¸ºï¼Œåœ¨ C è¯­è¨€ä¸­æ„æˆä¸€ä¸ª<strong>å¼ºå®šä¹‰</strong>ã€‚</li>
<li>C è¯­è¨€è§„èŒƒè¦æ±‚ï¼Œåœ¨<strong>å•ä¸ªç¼–è¯‘å•å…ƒ</strong>ï¼ˆå³å•ä¸ª <code>.c</code> æ–‡ä»¶ï¼‰ä¸­ï¼Œ<strong>ä¸å…è®¸å¯¹åŒä¸€ä¸ªå˜é‡è¿›è¡Œå¤šæ¬¡å¼ºå®šä¹‰</strong>ã€‚</li>
<li>è¿™è¿åäº†â€œå•ä¸€å®šä¹‰åŸåˆ™â€ï¼Œå› æ­¤ç¼–è¯‘å™¨ç«‹å³æŠ¥é”™ <code>redefinition of 'dummy'</code>ã€‚</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="äº†è§£makefile">äº†è§£Makefile</h3>
<p><strong>é—®é¢˜ï¼š</strong> è¯·æè¿°ä½ åœ¨am-kernels/kernels/hello/ç›®å½•ä¸‹æ•²å…¥make ARCH=$ISA-nemu å, makeç¨‹åºå¦‚ä½•ç»„ç»‡.cå’Œ.hæ–‡ä»¶, æœ€ç»ˆç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶am-kernels/kernels/hello/build/hello-$ISA-nemu.elf.
(è¿™ä¸ªé—®é¢˜åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢:Makefileçš„å·¥ä½œæ–¹å¼å’Œç¼–è¯‘é“¾æ¥çš„è¿‡ç¨‹.)
å…³äºMakefileå·¥ä½œæ–¹å¼çš„æç¤º:</p>
<ul>
<li>Makefileä¸­ä½¿ç”¨äº†å˜é‡, åŒ…å«æ–‡ä»¶ç­‰ç‰¹æ€§</li>
<li>Makefileè¿ç”¨å¹¶é‡å†™äº†ä¸€äº›implicit rules</li>
<li>åœ¨man makeä¸­æœç´¢-né€‰é¡¹, ä¹Ÿè®¸ä¼šå¯¹ä½ æœ‰å¸®åŠ©</li>
<li>RTFM</li>
</ul>
<p><strong>Solution</strong></p>
<h4 id="1makefile-çš„å·¥ä½œæ–¹å¼">1.Makefile çš„å·¥ä½œæ–¹å¼</h4>
<p>åœ¨ <code>am-kernels/kernels/hello/</code> ç›®å½•ä¸‹æ‰§è¡Œ <code>make ARCH=$ISA-nemu</code> åï¼Œ<code>make</code> ç¨‹åºä¼šæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ç»„ç»‡å’Œæ‰§è¡Œï¼š</p>
<h5 id="ç›®æ ‡ä¸å˜é‡ç¡®å®š"><strong>ç›®æ ‡ä¸å˜é‡ç¡®å®š</strong></h5>
<ol>
<li><strong>åŠ è½½æœ¬åœ° Makefile</strong>ï¼šé¦–å…ˆåŠ è½½ <code>am-kernels/kernels/hello/Makefile</code>ã€‚
<ul>
<li><strong>å˜é‡è®¾ç½®</strong>ï¼š<code>NAME = hello</code>, <code>SRCS = hello.c</code>ã€‚</li>
</ul>
</li>
<li><strong>åŒ…å«é€šç”¨ Makefile</strong>ï¼šé€šè¿‡ <code>include $(AM_HOME)/Makefile</code> åŒ…å« AbstractMachine çš„é€šç”¨ Makefileã€‚é€šç”¨ Makefile ä¸­çš„è§„åˆ™å’Œå˜é‡å¼€å§‹ç”Ÿæ•ˆã€‚</li>
<li><strong>ç¡®å®šç›®æ ‡</strong>ï¼šç”±äºå‘½ä»¤è¡Œæ²¡æœ‰æŒ‡å®šç›®æ ‡ (<code>MAKECMDGOALS</code> ä¸ºç©º)ï¼Œæ ¹æ®é€šç”¨ Makefile ä¸­çš„è®¾ç½®ï¼Œé»˜è®¤ç›®æ ‡ä¸º <code>image</code> (<code>MAKECMDGOALS = image</code>, <code>.DEFAULT_GOAL = image</code>)ã€‚</li>
<li><strong>ç¯å¢ƒæ£€æŸ¥å’Œå˜é‡è§£æ</strong>ï¼š
<ul>
<li>é€šè¿‡ <code>ARCH_SPLIT</code> å’Œ <code>word</code> å‡½æ•°ï¼Œä» <code>ARCH=$ISA-nemu</code> ä¸­è§£æå‡º <strong>ISA</strong> (riscv32) å’Œ <strong>PLATFORM</strong> (<code>nemu</code>)ã€‚</li>
<li><strong>ç¡®å®šè·¯å¾„</strong>ï¼š<code>DST_DIR</code> è¢«è®¾ç½®ä¸º <code>am-kernels/kernels/hello/build/$ARCH-nemu</code>ã€‚</li>
<li><strong>ç¡®å®šæœ€ç»ˆæ–‡ä»¶</strong>ï¼š<code>IMAGE</code> å˜é‡ç¡®å®šæœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„å‰ç¼€ï¼Œæœ€ç»ˆçš„ ELF æ–‡ä»¶ç›®æ ‡æ˜¯ <code>$(IMAGE).elf</code>ï¼Œå³ <code>am-kernels/kernels/hello/build/hello-$ISA-nemu.elf</code>ã€‚</li>
<li><strong>ç¡®å®šé“¾æ¥æ–‡ä»¶</strong>ï¼š<code>OBJS</code> å˜é‡è¢«è®¾ç½®ä¸º <code>$(DST_DIR)/hello.o</code>ã€‚<code>LIBS</code> å˜é‡åŒ…å« <code>am</code> å’Œ <code>klib</code>ã€‚<code>LINKAGE</code> åˆå§‹ä¸º <code>$(OBJS)</code>ã€‚</li>
</ul>
</li>
<li><strong>å¯¼å…¥æ¶æ„ç‰¹å®šé…ç½®</strong>ï¼šé€šè¿‡ <code>-include $(AM_HOME)/scripts/$(ARCH).mk</code> å¯¼å…¥ç‰¹å®šäº <code>$ISA-nemu</code> çš„é…ç½®ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨ã€é“¾æ¥è„šæœ¬ (<code>LDSCRIPTS</code>) å’Œé¢å¤–çš„ç¼–è¯‘/é“¾æ¥æ ‡å¿—ã€‚</li>
</ol>
<h5 id="ä¾èµ–é€’å½’ä¸å±•å¼€"><strong>ä¾èµ–é€’å½’ä¸å±•å¼€</strong></h5>
<ol>
<li><strong>é“¾æ¥ä¾èµ–çš„å±•å¼€</strong>ï¼šç”±äºç›®æ ‡æ˜¯ <code>image</code>ï¼Œ<code>Makefile</code> ä¸ä¼šæ‰§è¡Œ <code>archive</code> ç›®æ ‡ã€‚
<ul>
<li><code>LIB_TEMPLATE</code> å®ä¼šä¸ºæ¯ä¸ªåº“ (<code>am</code>, <code>klib</code>) ç”Ÿæˆä¸€ä¸ªä¾èµ–è§„åˆ™ï¼Œç›®æ ‡æ˜¯åº“çš„å½’æ¡£æ–‡ä»¶ (å¦‚ <code>$(AM_HOME)/am/build/am-$ARCH.a</code>)ã€‚</li>
<li>è¿™äº›åº“çš„å½’æ¡£æ–‡ä»¶è¢«æ·»åŠ åˆ° <code>LINKAGE</code> ä¸­ã€‚</li>
<li><strong>é€’å½’è°ƒç”¨</strong>ï¼šå½“éœ€è¦æ„å»ºè¿™äº›åº“å½’æ¡£æ–‡ä»¶æ—¶ï¼Œ<code>make</code> ä¼šé€’å½’è°ƒç”¨è‡ªèº«ï¼Œè¿›å…¥åº“çš„ç›®å½• (<code>$(AM_HOME)/am</code> æˆ– <code>$(AM_HOME)/klib</code>)ï¼Œå¹¶ä»¥ <code>archive</code> ä¸ºç›®æ ‡æ‰§è¡Œ <code>make</code> (<code>@$(MAKE) -s -C $(AM_HOME)/$(1) archive</code>)ã€‚</li>
</ul>
</li>
<li><strong>æ„å»ºé¡ºåº</strong>ï¼š<code>image</code> -&gt; <code>image-dep</code> -&gt; <strong><code>$(IMAGE).elf</code></strong>ã€‚</li>
</ol>
<h4 id="2-cæ–‡ä»¶çš„ç¼–è¯‘é“¾æ¥è¿‡ç¨‹">2. Cæ–‡ä»¶çš„ç¼–è¯‘é“¾æ¥è¿‡ç¨‹</h4>
<p>ç”Ÿæˆ <code>am-kernels/kernels/hello/build/hello-$ISA-nemu.elf</code> æ–‡ä»¶ä¸»è¦ç»è¿‡ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<h5 id="1-ç¼–è¯‘">1. ç¼–è¯‘</h5>
<ul>
<li><strong>ç›®æ ‡</strong>ï¼šå°†æºä»£ç æ–‡ä»¶ <code>hello.c</code> ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ <code>$(DST_DIR)/hello.o</code> (å³ <code>am-kernels/kernels/hello/build/$ISA-nemu/hello.o</code>)ã€‚</li>
<li><strong>è§„åˆ™</strong>ï¼šä½¿ç”¨é€šç”¨ Makefile ä¸­é‡å†™çš„ç¼–è¯‘è§„åˆ™ï¼š
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">$(DST_DIR)/%.o</span><span class="o">:</span> %.<span class="n">c</span>
</span></span><span class="line"><span class="cl">    @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> + CC $&lt;
</span></span><span class="line"><span class="cl">    @<span class="k">$(</span>CC<span class="k">)</span> -std<span class="o">=</span>gnu11 <span class="k">$(</span>CFLAGS<span class="k">)</span> -c -o <span class="nv">$@</span> <span class="k">$(</span>realpath $&lt;<span class="k">)</span>
</span></span></code></pre></div></li>
<li><strong>æ‰§è¡Œå‘½ä»¤</strong>ï¼š<code>make</code> ä¼šæ‰§è¡Œç±»ä¼¼å¦‚ä¸‹çš„å‘½ä»¤ï¼š
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc -std<span class="o">=</span>gnu11 -O2 -MMD -Wall -Werror <span class="o">[</span>å„ç§ -I&lt;path&gt; å¤´æ–‡ä»¶è·¯å¾„<span class="o">]</span> <span class="o">[</span>å„ç§ -D&lt;macro&gt; å®å®šä¹‰<span class="o">]</span> -fno-builtin ... -c -o build/<span class="nv">$ISA</span>-nemu/hello.o hello.c
</span></span></code></pre></div><ul>
<li><strong><code>$(CC)</code></strong>ï¼šä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨ï¼ˆä¾‹å¦‚ <code>mips64-linux-gnu-gcc</code> æˆ– <code>riscv64-unknown-elf-gcc</code>ï¼Œå–å†³äº <code>ARCH</code>ï¼‰ã€‚</li>
<li><strong><code>$(CFLAGS)</code></strong>ï¼šåŒ…å«äº†ä¼˜åŒ–é€‰é¡¹ (<code>-O2</code>)ã€è­¦å‘Š/é”™è¯¯é€‰é¡¹ (<code>-Wall -Werror</code>)ã€å¤´æ–‡ä»¶è·¯å¾„ (<code>-I</code>) å’Œé‡è¦çš„å®å®šä¹‰ (<code>-D__ISA__</code> ç­‰)ï¼›æ­¤å¤–è¿˜æœ‰åµŒå…¥å¼/è£¸æœºç¼–ç¨‹å¸¸ç”¨çš„é€‰é¡¹ (<code>-fno-builtin</code>, <code>-fno-stack-protector</code>)ã€‚</li>
<li><strong><code>-MMD</code></strong>ï¼šè¯¥é€‰é¡¹æŒ‡ç¤ºç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ª <code>.d</code> æ–‡ä»¶ (<code>build/$ISA-nemu/hello.d</code>)ï¼Œå…¶ä¸­åŒ…å«ç›®æ ‡æ–‡ä»¶ <code>hello.o</code> å¯¹æ‰€æœ‰ä¾èµ–å¤´æ–‡ä»¶çš„ä¿¡æ¯ã€‚è¿™ä¸ª <code>.d</code> æ–‡ä»¶ä¼šè¢« <code>-include</code> å¯¼å…¥åˆ° Makefile ä¸­ï¼Œä»è€Œå®ç°å¤´æ–‡ä»¶ä¿®æ”¹æ—¶ï¼Œ<code>.o</code> æ–‡ä»¶ä¹Ÿèƒ½è¢«æ­£ç¡®åœ°é‡æ–°ç¼–è¯‘ã€‚</li>
</ul>
</li>
</ul>
<h5 id="2-å½’æ¡£">2. å½’æ¡£</h5>
<ul>
<li><strong>ç›®æ ‡</strong>ï¼šå°† AbstractMachine å†…æ ¸å’Œåº“ï¼ˆ<code>am</code> å’Œ <code>klib</code>ï¼‰çš„æºä»£ç ç¼–è¯‘ç”Ÿæˆå„è‡ªçš„é™æ€åº“æ–‡ä»¶ (e.g., <code>$(AM_HOME)/am/build/am-$ARCH.a</code>)ã€‚</li>
<li><strong>è§„åˆ™</strong>ï¼šé€šè¿‡é€’å½’è°ƒç”¨ <code>make archive</code> åœ¨å„ä¸ªåº“çš„ç›®å½•ä¸‹å®Œæˆã€‚</li>
</ul>
<h5 id="3-é“¾æ¥">3. é“¾æ¥</h5>
<ul>
<li><strong>ç›®æ ‡</strong>ï¼šå°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ (<code>hello.o</code>) å’Œæ‰€æœ‰ä¾èµ–çš„åº“æ–‡ä»¶ (<code>am-$ARCH.a</code>, <code>klib-$ARCH.a</code>) é“¾æ¥èµ·æ¥ï¼Œç”Ÿæˆæœ€ç»ˆçš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ <code>$(IMAGE).elf</code>ã€‚</li>
<li><strong>è§„åˆ™</strong>ï¼šä½¿ç”¨é“¾æ¥è§„åˆ™ï¼š
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">$(IMAGE).elf</span><span class="o">:</span> <span class="k">$(</span><span class="nv">LINKAGE</span><span class="k">)</span> <span class="k">$(</span><span class="nv">LDSCRIPTS</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    @<span class="k">$(</span>LD<span class="k">)</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> --start-group <span class="k">$(</span>LINKAGE<span class="k">)</span> --end-group
</span></span></code></pre></div></li>
<li><strong>æ‰§è¡Œå‘½ä»¤</strong>ï¼š<code>make</code> ä¼šæ‰§è¡Œç±»ä¼¼å¦‚ä¸‹çš„å‘½ä»¤ï¼š
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ld -z noexecstack -T &lt;link_script&gt; -o build/hello-<span class="nv">$ISA</span>-nemu.elf --start-group <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    build/<span class="nv">$ISA</span>-nemu/hello.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /path/to/am/build/am-<span class="nv">$ISA</span>-nemu.a <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /path/to/klib/build/klib-<span class="nv">$ISA</span>-nemu.a <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --end-group
</span></span></code></pre></div><ul>
<li><strong><code>$(LD)</code></strong>ï¼šä½¿ç”¨äº¤å‰é“¾æ¥å™¨ã€‚</li>
<li><strong><code>$(LDFLAGS)</code></strong>ï¼šåŒ…å« <code>LDSCRIPTS</code> å˜é‡æŒ‡å®šçš„é“¾æ¥è„šæœ¬ (<code>-T</code>)ã€‚å®ƒå®šä¹‰äº†ä»£ç æ®µã€æ•°æ®æ®µåœ¨å†…å­˜ä¸­çš„å¸ƒå±€ã€å…¥å£ç‚¹ç­‰ä¿¡æ¯ã€‚</li>
<li><strong><code>$(LINKAGE)</code></strong>ï¼šåŒ…å«æ‰€æœ‰ <code>.o</code> æ–‡ä»¶å’Œ <code>.a</code> åº“æ–‡ä»¶ã€‚</li>
<li><strong><code>--start-group ... --end-group</code></strong>ï¼šç¡®ä¿åº“æ–‡ä»¶ä¹‹é—´å¦‚æœå­˜åœ¨ç›¸äº’ä¾èµ–ï¼Œé“¾æ¥å™¨ä¹Ÿèƒ½æ­£ç¡®è§£ææ‰€æœ‰ç¬¦å·ã€‚</li>
</ul>
</li>
</ul>
<p>è‡³æ­¤ï¼Œ<code>am-kernels/kernels/hello/build/hello-$ISA-nemu.elf</code> å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚</p>
<hr>
<h2 id="æ€è€ƒé¢˜">æ€è€ƒé¢˜</h2>
<p><img src="Problem1.png" alt="Problem">
RISC-V æä¾›äº†ä¸“é—¨çš„æŒ‡ä»¤æ¥é«˜æ•ˆåœ°åŠ è½½ 32 ä½å¸¸æ•°ï¼š</p>
<ul>
<li>LUI (Load Upper Immediate): åŠ è½½é«˜ 20 ä½ç«‹å³æ•°ã€‚</li>
<li>ADDI (Add Immediate): åŠ è½½ä½ 12 ä½ç«‹å³æ•°ï¼ˆå¹¶è¿›è¡Œç¬¦å·æ‰©å±•ï¼‰ã€‚</li>
</ul>
<p><img src="Problem2.png" alt="Problem2">
æµ‹è¯•è¿”å›ï¼š
<img src="Answer_of_Problem2.png" alt="Answer"></p>
<hr>
<h2 id="æœ‰è¶£çš„ç¬é—´">æœ‰è¶£çš„ç¬é—´</h2>
<p><img src="bad_apple.png" alt="bad apple"></p>
<hr>
<p><img src="cmatrix_1.png" alt="cmatrix 1"></p>
<hr>
<p><img src="cmatrix_2.png" alt="cmatrix 2"></p>
<hr>
<p><img src="cpu-tests.png" alt="cpu tests"></p>
<hr>
<p><img src="riscv32-nemu_benchmarks.png" alt="riscv32"></p>
<hr>
<p><img src="native_benchmarks.png" alt="native"></p>
<hr>
<p><img src="display-test.png" alt="display test"></p>
<hr>
<p><img src="mario.png" alt="mario"></p>
<hr>
<h2 id="å®éªŒå¿ƒæƒ…">å®éªŒå¿ƒæƒ…</h2>
<p>ğŸ˜Š æ„Ÿè§‰è‰¯å¥½</p>

      </div>
    </div>
    
    
      <footer class="post-footer">
        <div class="post-tags">
          
            <a href="/tags/ics/" class="tag-link">#ICS</a>
          
            <a href="/tags/pa/" class="tag-link">#PA</a>
          
        </div>
      </footer>
    
  </div>
</article>

      </section>
    </div>
  </main>
  
  <footer class="footer" data-liquid-glass="footer">
  <div class="container">
    <div class="footer-inner">
      <div class="footer-info">
        <p class="copyright">
          Â© 2025 - 2026 OCTOPUS
        </p>
        <p class="powered">
          Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> & Designed By Myself
        </p>
      </div>
      
    </div>
  </div>
</footer>

  
  
  <button class="fab-sidebar-toggle" id="fabSidebarToggle" aria-label="æ‰“å¼€ä¾§è¾¹æ ">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>
  
  
  <div class="sidebar-drawer" id="sidebarDrawer">
    <div class="sidebar-drawer-header">
      <span class="sidebar-drawer-title">å¯¼èˆª</span>
      <button class="sidebar-drawer-close" id="sidebarDrawerClose" aria-label="å…³é—­">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="sidebar-drawer-content">
      <div class="sidebar-inner">
  
  <div class="sidebar-card blog-title-card">
    <a href="/" class="blog-title-link">
      <span class="blog-title-text">DIMS</span>
    </a>
  </div>

  <div class="sidebar-card profile-card">
    <div class="avatar">
      <img src="https://avatars.githubusercontent.com/u/204014295?v=4" alt="OCTOPUS">
    </div>
    <div class="profile-info">
      <h3>OCTOPUS</h3>
      <p>çƒ­çˆ±æŠ€æœ¯ï¼Œçƒ­çˆ±ç”Ÿæ´»ã€‚</p>
    </div>
    <div class="profile-meta">
      <span>Since 2025</span>
      
        <span>github</span>
      
    </div>
  </div>

  
  <div class="sidebar-card">
    <h4 class="sidebar-title">
      <a href="/categories/" class="sidebar-title-link">
        <span class="title-icon">ğŸ“</span>
        <span>åˆ†ç±»</span>
      </a>
    </h4>
    <ul class="sidebar-list">
      
      <li>
        <a href="/categories/%E6%8A%A5%E5%91%8A/" class="sidebar-link">
          <span class="link-name">æŠ¥å‘Š</span>
          <span class="count">4</span>
        </a>
      </li>
      
    </ul>
  </div>
  

  
  <div class="sidebar-card">
    <h4 class="sidebar-title">
      <a href="/tags/" class="sidebar-title-link">
        <span class="title-icon">ğŸ·ï¸</span>
        <span>æ ‡ç­¾</span>
      </a>
    </h4>
    <div class="tag-cloud-compact">
      
        <a href="/tags/ics/" class="tag-item-compact" title="4 ç¯‡æ–‡ç« ">
          ICS
        </a>
      
        <a href="/tags/pa/" class="tag-item-compact" title="4 ç¯‡æ–‡ç« ">
          PA
        </a>
      
    </div>
  </div>
  

  
  <div class="sidebar-card">
    <h4 class="sidebar-title">
      <span class="title-icon">ğŸ“</span>
      <span>æœ€è¿‘æ–‡ç« </span>
    </h4>
    <ul class="sidebar-list recent-posts">
      
      <li>
        <a href="/2026/02/09/ics_pa4-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" class="sidebar-link recent-post-link">
          <span class="link-name recent-post-title">ICS_PA4 å®éªŒæŠ¥å‘Š</span>
          <span class="date">02-09</span>
        </a>
      </li>
      
      <li>
        <a href="/2025/12/12/ics_pa3-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" class="sidebar-link recent-post-link">
          <span class="link-name recent-post-title">ICS_PA3 å®éªŒæŠ¥å‘Š</span>
          <span class="date">12-12</span>
        </a>
      </li>
      
      <li>
        <a href="/2025/11/11/ics_pa2-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" class="sidebar-link recent-post-link">
          <span class="link-name recent-post-title">ICS_PA2 å®éªŒæŠ¥å‘Š</span>
          <span class="date">11-11</span>
        </a>
      </li>
      
      <li>
        <a href="/2025/09/24/ics_pa1-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" class="sidebar-link recent-post-link">
          <span class="link-name recent-post-title">ICS_PA1 å®éªŒæŠ¥å‘Š</span>
          <span class="date">09-24</span>
        </a>
      </li>
      
    </ul>
  </div>
  
</div>

    </div>
  </div>
  
  
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  
  
  <script src="/js/snow-ground.min.js"></script>
  
  <script src="/js/liquidGlass.min.js"></script>
  
  <script src="/js/main.min.js"></script>
  
  
    
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        if (typeof renderMathInElement !== 'undefined') {
          renderMathInElement(document.body, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\[', right: '\\]', display: true},
              {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
          });
        }
      });
    </script>
  
</body>
</html>
